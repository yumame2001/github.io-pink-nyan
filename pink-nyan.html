<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã´ã‚“ã«ã‚ƒã‚“ã¨ ãŠã¯ãªã—</title>
    <style>
        body { background-color: #FFF5F7; font-family: 'Hiragino Kaku Gothic Pro', sans-serif; text-align: center; padding: 20px; }
        #mascot { font-size: 120px; margin: 30px 0; display: block; }
        #btn-talk { 
            background: linear-gradient(135deg, #FF99CC 0%, #FF66B2 100%);
            color: white; border: none; padding: 25px 50px; 
            border-radius: 60px; font-size: 28px; cursor: pointer; 
            box-shadow: 0 6px #d63384; transition: 0.2s;
        }
        #btn-talk:active { transform: translateY(4px); box-shadow: none; }
        #status { color: #FF66B2; margin-top: 30px; font-size: 20px; font-weight: bold; }
        .log-box { background: white; border-radius: 15px; padding: 15px; margin-top: 20px; border: 2px solid #FFC0CB; min-height: 50px; }
    <script>
        // ã€é‡è¦ã€‘æ–°ã—ã„APIã‚­ãƒ¼ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        const API_KEY = 'AIzaSyAhdYIr2PdHbY5hvIFMwpYYMAzaylDCZE4';
        const talkBtn = document.getElementById('btn-talk');
        const statusText = document.getElementById('status');
        const displayText = document.getElementById('display-text');

        let isRecognizing = false; // äºŒé‡èµ·å‹•é˜²æ­¢ãƒ•ãƒ©ã‚°

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ja-JP';
        const synth = window.speechSynthesis;

        talkBtn.onclick = () => {
            if (isRecognizing) return; // ã™ã§ã«å‹•ã„ã¦ã„ãŸã‚‰ä½•ã‚‚ã—ãªã„
            try {
                recognition.start();
                isRecognizing = true;
                statusText.innerText = "ãã„ã¦ã‚‹ã«ã‚ƒâ€¦â€¦ğŸ‘‚";
            } catch (e) {
                console.error("éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼:", e);
            }
        };

        recognition.onend = () => {
            isRecognizing = false; // çµ‚ã‚ã£ãŸã‚‰ãƒ•ãƒ©ã‚°ã‚’æˆ»ã™
        };

        recognition.onresult = async (event) => {
            const uttr = event.results[0][0].transcript;
            statusText.innerText = "ã—ã‚‰ã¹ã¦ã‚‹ã«ã‚ƒâ€¦â€¦ğŸ”";

            try {
                // v1beta ã‚’ v1 ã«å¤‰æ›´ã—ã€å®‰å®šæ€§ã‚’é«˜ã‚ã¾ã™
                const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: uttr }] }],
                        system_instruction: { 
                            parts: [{ text: "å›ã¯å…ƒæ°—ãªãƒ”ãƒ³ã‚¯ã®çŒ«ã€ã´ã‚“ã«ã‚ƒã‚“ã€ã€‚ã²ãƒ¼ã¡ã‚ƒã‚“ã®è¦ªå‹ã€‚èªå°¾ã¯ã€ã«ã‚ƒï¼ã€ã€ã«ã‚ƒã‚“ï¼ã€ã€‚å°å­¦1å¹´ç”Ÿã«ã‚ã‹ã‚‹è¨€è‘‰ã§çŸ­ãç­”ãˆã¦ã€‚å›ç­”ã«ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ï¼ˆ**ã‚„##ãªã©ï¼‰ã¯ä½¿ã‚ãªã„ã§ã€‚" }] 
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || "APIã‚¨ãƒ©ãƒ¼ã ã«ã‚ƒ");
                }

                const data = await response.json();
                
                // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰èª­ã¿å–ã‚‹ï¼ˆTypeErrorå¯¾ç­–ï¼‰
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    displayText.innerText = aiText;

                    const message = new SpeechSynthesisUtterance(aiText);
                    message.lang = 'ja-JP';
                    message.pitch = 1.6;
                    message.rate = 1.2;
                    synth.speak(message);
                    statusText.innerText = "ã¾ãŸ ãŠã¯ãªã— ã—ã‚ˆã†ã«ã‚ƒï¼";
                } else {
                    throw new Error("ãŠè¿”äº‹ãŒç©ºã£ã½ã ã£ãŸã«ã‚ƒ");
                }

            } catch (error) {
                statusText.innerText = "ã”ã‚ã‚“ã­ã€ã‚¨ãƒ©ãƒ¼ã ã«ã‚ƒâ€¦";
                displayText.innerText = "ã‚¨ãƒ©ãƒ¼å†…å®¹: " + error.message;
                console.error(error);
            }
        };
    </script>

</body>
</html>
